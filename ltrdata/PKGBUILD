# Maintainer: David Macek <david.macek.0@gmail.com>

_extract_subdir() {
    local _file="$(get_filename "${1}")"
    local _dir="${_file%.*}"
    if type bsdtar | head -1 | grep -q 'is a function'
    then
        local _original_bsdtar="$(type bsdtar | tail +2)"
    fi
    bsdtar() {
        local _extra_args=()
        if [ "${1}" = "-xf" ]
        then
            mkdir -p "${_dir}"
            _extra_args=(-C "${_dir}")
        fi
        /usr/bin/bsdtar "${_extra_args[@]}" "${@}"
    }
    extract_file "${_file}"
    unset -f bsdtar
    eval "${_original_bsdtar}"
}

download_http@subdir() {
    download_file "${1/@subdir:/:}"
}

extract_http@subdir() {
    _extract_subdir "${@}"
}

_realname=ltrdata
pkgbase="app-${_realname}"
pkgname=("app-x86_64-${_realname}")
epoch=1
pkgver=2022.06.12
pkgrel=1
pkgdesc="Collection of small and useful freeware utilities by Lagerkvist Teknisk Radgivnings"
url="http://www.ltr-data.se/opencode.html"
arch=('any')
license=('custom')
replaces=("app-i686-${_realname}")
makedepends=("p7zip")
provides=("${pkgbase}")
options=(!strip)
source=(
        # ImDisk Virtual Disk Driver
        "imdiskinst.exe::http://www.ltr-data.se/files/imdiskinst.exe"
        "devio64.zip::http@subdir://www.ltr-data.se/files/win64/devio.zip"
        "ImDiskNet.7z::http@subdir://www.ltr-data.se/files/ImDiskNet.7z"

        # Zero and Random device driver
        "zerodrv.exe::http://www.ltr-data.se/files/zerodrv.exe"

        # others
        "exefiles.zip::http@subdir://www.ltr-data.se/files/exefiles.zip"
        "exefiles64.zip::http@subdir://www.ltr-data.se/files/win64/exefiles.zip"
        "DotNetFileTools.zip::http@subdir://www.ltr-data.se/files/net6.0/DotNetFileTools.zip"
        "DotNetFileTools-windows.zip::http@subdir://www.ltr-data.se/files/net6.0-windows/DotNetFileTools.zip"
        "MathTools.zip::http@subdir://www.ltr-data.se/files/net6.0/MathTools.zip"
        "MathTools-windows.zip::http@subdir://www.ltr-data.se/files/net6.0-windows/MathTools.zip"
        "SystemTools.zip::http@subdir://www.ltr-data.se/files/net6.0/SystemTools.zip"
        "SystemTools-windows.zip::http@subdir://www.ltr-data.se/files/net6.0-windows/SystemTools.zip"
        "MailTools.zip::http@subdir://www.ltr-data.se/files/net6.0/MailTools.zip"
        "HyperV.zip::http@subdir://www.ltr-data.se/files/net6.0-windows/HyperV.zip"
        "xmlvalidate.zip::http@subdir://www.ltr-data.se/files/net6.0/xmlvalidate.zip"
        "QuickBrowser.zip::http@subdir://www.ltr-data.se/files/net6.0-windows/QuickBrowser.zip"

        # secret
        "scripts.zip::http@subdir://www.ltr-data.se/files/scripts.zip"
)
sha512sums=('5e6a38df7cc8abdc54a7bf17b286cb14ae52c402592ba659a3458a461f5bdfa1beae8890c66dd333ab7d2622f946a51a78a2076ece891ddd84fe4b7cc7fd4185'
            '156b163fdc038bb9924b2dde4ed1b2416fd09d2c0f0b8fd85a0f9a0d6b740be7daa0510ec4e7bded5573eda7d59510b859e33efe7b3d7b0dc2ce45bb95936bd0'
            '2ffbc129febee2667c54c068d04dff97aa6b6dcdcd828b0b8c3770d0133fd3e7390e067c16c86dfbcffc2a21c874622d415e04a8aa220bdd02665088c4f98929'
            '846acc5130f99dfb63d5a7d03f3f0628b327e1846907f87825a9e954cb3a9bd72681e9072dd07171ac06556cfeacc7be5a4172cbb8052fc45b45e5c0d31b2635'
            '97926b1a9fc8ad1cfad24fb367a213afa96f7e4129ffd4b0e52b6f9be167b06fb62296688312c9d075e3748adf9ae82e8812999971fc89ff3aa3aa2aa116e90b'
            '257e7eb32205706f05c13f36d5007901af14d28055f6925a1156b1a4a2fcda31c16b584328e52b46c9c30fa9d389cb893eca3267f1205ceac9c2ac775d8fa45c'
            'd784c6d54caab5a482784d05dcd6c48e786fe671a4ccdca0076d0d5474967f56133a5f2f7fe46381cd7289b8393b446b6152127aed5cf5a339d61440f2b9bfc3'
            'ff540b42097318674d794f415e1dc43684bcbdccf6926e0d942ce0c536a951911eab8aa9e16eec5de88915c3b9c946ddec91440119ff5fa1dd3198d13f6f92a3'
            'dd6f4eec9e63e2e6f6f18e66b9149ec44dc70cf220d7ef9c2538ef435799d09e040a50d37782be169b9dc9c0454c2323b4c5b57c757563e0de1d71debeda02b0'
            '4885414c2b146c9dc9b4dbd90b34fa33924672d939a2e5230c32837ff0617bed23d37f0120e85a595c301a8c94d4096c44d39cc0e7e8f6e098e39ec5229ee103'
            '2e4a5ef6ea80266268e44d5b577d7ae38c6c7cd3e3a1b84a94f0c6551fc5a1a59d9b31a981f8719592d5cf6e997ef9a5807ea226db0f10234b8771f09b20a34c'
            '9126241e49ff9ce3639757ec265058c659d1a3582b36f4b0f07fdabe67b5574936ee89ef1b73653fbc6f0ee1f052f332179dc404a06c1ffafd94c059d0a818ac'
            '23c32f1537eb6bce718da2381877c6ad8032850a3ad56355ce32f472c376d79b6c4d8774b866d6f13b417c3a2b5879c9503127dcbd43c1b8d72322c921f05eb8'
            'dc1214729794094c27f6e78df686275ddc22ec9088550a1d8a92234f65289cd23b509eb2d7469d3516f1fa2808ea5162550e1db9b3f59c88c87b6d2e1d2d1e60'
            'fcb2af1d5b14f2238ed1857365cc225f4beeac422c31956458c74b7c9b69736e48b5123a017a4cb79d090e083778b5ee68169b059b8f55de0660c3f5cc9ec89b'
            '0e496e39253d94ef359d3b8674ec763db7d4f0289227cf586e23e68ed27bef89503686880994f3db40065bed9adf060dbdb0aaae2582f43b7aeff58de90e6379'
            '2f7c7011871898829ad1392a85c537ee6dfb2ea8f2eaa0619db1be4fbd0cf4c7239762d6d3c34772311e2e3440246fc6e6fe6116e92a358b340598eb05e0bdde')

prepare() {
    7z x -y -bd "imdiskinst.exe" -o"imdiskinst.dir" > /dev/null
    7z x -y -bd "zerodrv.exe" -o"zerodrv.dir" > /dev/null
}

pkgver() {
    find . -mindepth 2 -type f -printf '%TY.%Tm.%Td\n' | sort | tail -1
}

package() {
    local a="${pkgdir}/apps/${_realname}"
    mkdir -p "${a}"

    local d
    for d in $(find . -mindepth 1 -maxdepth 1 -type d | grep -v "exefiles" | grep -v "[.]dir$" | grep -v "ImDiskNet")
    do
        cp -R "${d}"/* "${a}"
    done
    cp "exefiles"/* "${a}"
    cp "exefiles64"/* "${a}"

    cp -R "imdiskinst.dir" "${a}/imdisk"
    cp -R "ImDiskNet" "${a}/imdisk/dotnet"
    cp -R "zerodrv.dir" "${a}/zerodrv"
    rm "${a}/imdisk/runwaitw.exe" "${a}/zerodrv/run64.exe"
    rm -R "${a}"/{imdisk,zerodrv}/*/{ARM,ARM64,i386,ia64} "${a}/zerodrv"/{win2k,winnet}
}
