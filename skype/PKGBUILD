# Maintainer: David Macek <david.macek.0@gmail.com>

_realname=skype
_apparch=32
pkgbase="app-${_realname}"
pkgname=("app-i686-${_realname}")
pkgver=7.40.32.104
pkgrel=1
pkgdesc="P2P software for high-quality voice communication"
url="http://www.skype.com/"
arch=('any')
license=('custom')
provides=("${pkgbase}")
options=(!strip)
source=("SkypeSetup.msi::http://www.skype.com/go/getskype-msi")
sha512sums=('ba022a1a8b022bb068b6d2a584e50b68e986122c4ba8fe5aca04f710295d4e9d54289c0f3226e6bd34050b0db811aa8b4b13635737c3a7154e876631c18a21f6')

_lc() {
    local d f n

    for f in "${@}"
    do
        d="$(dirname "${f}")"
        f="$(basename "${f}")"
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${d}/${f}" "${d}/${n}"
        fi
    done
}

pkgver() {
    msg2 "Starting build() to determine package version :("
    build > /dev/null
    b="install/Program Files/Skype/Phone/skype.exe"
    if [ -f "${b}" ]
    then
        b="$(cygpath -wa "${b}" | sed 's/\\/\\\\/g')"
        wmic datafile where name=\""${b}"\" get version | grep 'Version' -A 1 | tail -1 | tr -d ' '
    fi
}

build() {
    msiexec -a "SkypeSetup.msi" "TARGETDIR=$(cygpath -wa "install")" -qn
    attrib -r //s
    s="install/Program Files/Skype"
    _lc "${s}/Phone"/* "${s}/Perfmon"/* "${s}/Redist/Skype"/* "${s}/PFiles/Skype/Browser"/*
}

package() {
    s="install/Program Files/Skype"

    a="${pkgdir}/apps${_apparch}/${_realname}"
    mkdir -p "${a}"
    cp "${s}/Phone"/* "${s}/Perfmon/performancecounters.mam" "${s}/PFiles/Skype/Browser/skypebrowserhost.exe" "${s}/Redist/Skype/skype4com.dll" "${a}"
    rm "${a}"/{vccorlib,vcruntime,msvcp,concrt}140.dll "${a}"/api-ms-win-*.dll "${a}/ucrtbase.dll"

    d="${pkgdir}/docs${_apparch}/${_realname}"
    mkdir -p "${d}"
    cp "${s}/third-party_attributions.txt" "${d}"
}
