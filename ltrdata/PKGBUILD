# Maintainer: David Macek <david.macek.0@gmail.com>

DLAGENTS=('http::/usr/bin/curl -qb "" -RfLC - -o %o %u')

_realname=ltrdata
pkgbase="app-${_realname}"
pkgname=("app-x86_64-${_realname}")
epoch=1
pkgver=2017.07.01
pkgrel=1
pkgdesc="Collection of small and useful freeware utilities by Lagerkvist Teknisk Radgivnings"
url="http://www.ltr-data.se/opencode.html"
arch=('any')
license=('custom')
replaces=("app-i686-${_realname}")
makedepends=("unzip" "curl")
provides=("${pkgbase}")
options=(!strip)
source=("exefiles.zip::http://www.ltr-data.se/files/exefiles.zip"
        "exefiles64.zip::http://www.ltr-data.se/files/win64/exefiles.zip"
        "scripts.zip::http://ltr-data.se/files/scripts.zip"
        "scripts64.zip::http://ltr-data.se/files/scripts.zip"

        "checksum.zip::http://www.ltr-data.se/files/checksum.zip"
        "coordtool.zip::http://www.ltr-data.se/files/coordtool.zip"
        "netcheck.zip::http://www.ltr-data.se/files/netcheck.zip"

        "devio.exe::http://www.ltr-data.se/files/devio.exe"

        # installers
        # "zerodrv.exe::http://www.ltr-data.se/files/zerodrv.exe"
        # "imdiskinst.exe::http://www.ltr-data.se/files/imdiskinst.exe"
        # "ImDiskNet.7z::http://www.ltr-data.se/files/ImDiskNet.7z"
)
sha512sums=('afcb6d51d1a6c243323b3f20f900d492ef83ba5b74f566414a2fe1cacc99b42ec65edbecb9fcb999599111b063e2e438b64e1e05d6ddca631a09b5bb5d4cb1d7'
            '639810078a3a38928587ff5370ef355645ad6d4f16c9c8ef4902717371ca28b8010c1ddf1cc6f6c0858febc79446e4ec3e87ccb11c878e01926962cdb4eb6922'
            '2f7c7011871898829ad1392a85c537ee6dfb2ea8f2eaa0619db1be4fbd0cf4c7239762d6d3c34772311e2e3440246fc6e6fe6116e92a358b340598eb05e0bdde'
            '2f7c7011871898829ad1392a85c537ee6dfb2ea8f2eaa0619db1be4fbd0cf4c7239762d6d3c34772311e2e3440246fc6e6fe6116e92a358b340598eb05e0bdde'
            '0cf74076fe57020215499b0c19c775500ba33c4d9101e06c0c0a4ab5e3d28cf8639edee156e324ca7b913304ca3b9a0a3f0ec59b5573de797b15f3d3856184db'
            '42963e4d9520e4513ae8ee29cb5ea1f53432f257f649eba8fc544c43573b09717046b2ba8eea3b0e7787c5bd24e6a59ab61065c46a6f6a00fa5e674df3c34960'
            'cabfa2db55284f457e04932a648120a4ccf4a1d5a24fc1a2d71d84a27f4255d2886c5b94659529ac8f7351f267474429912f0ff21afc4767061c3b124d3faf67'
            '56927c653e62000223b964c67fa57a35a96fc8409e85b2d6561b649fa991aa75c9ab29cb27941716c5a91d0d771839edd5324d6079d7bcd0d2721e243bda9c3d')
noextract=("${source[@]##*/}")

_lc() {
    local d f n

    for f in "${@}"
    do
        d="$(dirname "${f}")"
        f="$(basename "${f}")"
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${d}/${f}" "${d}/${n}"
        fi
    done
}

pkgver() {
    #find . -mindepth 1 -maxdepth 2 -name '*.exe' -printf '%TY.%Tm.%Td\n' | sort | tail -1
    find . -mindepth 1 -maxdepth 1 -name '*.zip' -execdir bash -c 'unzip -l "{}" | tail -n +4 | head -n -2 | sed -r "s/[ ]+/\t/g" | cut -f 3 | tr "-" "."' \; \
      -o -name '*.exe' -printf '%TY.%Tm.%Td\n' \
      | sort | tail -1
}

prepare() {
    for f in *.zip
    do
        unzip -o "${f}" -d "${f%%.zip}"
        _lc "${f%%.zip}"/*
    done
}

package() {
    a="${pkgdir}/apps/${_realname}"
    mkdir -p "${a}"
    for s in *.zip
    do
        s="${s%%.zip}"
        u="${s##*/}"
        u="${u%%64}"
        echo "${u}"
        find "${s}" -regextype posix-extended -regex ".+\.(exe|dll|exe\.config|cmd|vbs|ps1)" -print0 | xargs -0 cp -t "${a}"
        find "${s}" -regextype posix-extended -regex ".+\.(txt|cnt|hlp)" -print0 | xargs -0r cp -t "${a}"
    done
}
