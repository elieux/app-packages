# Maintainer: David Macek <david.macek.0@gmail.com>

# adding quotes around the cookie value makes the download fail
DLAGENTS=('http::/usr/bin/curl -qb oraclelicense=accept-securebackup-cookie -fLC - -o %o %u')

_apparch=64
_realname=jdk
_realver=9+181
pkgbase="app-${_realname}"
pkgname=("app-x86_64-${_realname}")
pkgver=${_realver%+*}u0
pkgrel=1
pkgdesc="Oracle Java Development Kit"
url="http://www.oracle.com/technetwork/java/javase/downloads/index.html"
arch=('any')
license=('custom')
makedepends=("p7zip" "unzip" "curl")
provides=("${pkgbase}")
options=(!strip)
source=("jdk-windows64.exe::http://download.oracle.com/otn-pub/java/jdk/${_realver}/jdk-${_realver%+*}_windows-x64_bin.exe")
sha512sums=('e51628f0b73080a6f444f0f82be46db43055d44f0666f85b149bcb719c69054be17b1082eb6fa8ef4a9ac5af6d48389eac91e61af22a2171338321c3e4a786c5')

_lc() {
    local d f n

    for f in "${@}"
    do
        d="$(dirname "${f}")"
        f="$(basename "${f}")"
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${d}/${f}" "${d}/${n}"
        fi
    done
}

prepare() {
    7z x -y -bd "jdk-windows${_apparch}.exe"
    unzip -o "tools.zip" -d "tools${_apparch}"
    attrib -r //s
    _lc "tools${_apparch}"/*
    for f in $(find "tools${_apparch}" -iname '*.pack' -type f)
    do
        "tools${_apparch}/bin/unpack200" "${f}" "${f%.pack}.jar"
        rm "${f}"
    done
}

package() {
    s="tools${_apparch}"

    a="${pkgdir}/apps${_apparch}/${_realname}"
    mkdir -p "${a}"
    cp -r "${s}"/* "${a}"
    rm "${a}"/bin{,/plugin2}/msvc{p,r}120.dll

    d="${pkgdir}/docs${_apparch}/${_realname}"
    mkdir -p "${d}"
    mv "${a}"/{release,readme.html} "${a}/legal" "${d}"
}
