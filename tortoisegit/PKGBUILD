# Maintainer: David Macek <david.macek.0@gmail.com>

_realname=tortoisegit
_choconame=TortoiseGit
pkgbase="app-${_realname}"
pkgname=("app-x86_64-${_realname}")
epoch=1
pkgver=2.14.0.1
pkgrel=1
pkgdesc="Git client implemented as a Windows shell extension"
url="https://tortoisegit.org"
arch=('any')
license=('GPL2')
replaces=("app-i686-${_realname}")
makedepends=("app-lessmsi")
provides=("${pkgbase}")
options=(!strip)
source=("TortoiseGit-64bit.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-${pkgver}-64bit.msi"
        "TortoiseGit-LanguagePack-64bit-sq.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sq.msi"
        "TortoiseGit-LanguagePack-64bit-bg.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-bg.msi"
        "TortoiseGit-LanguagePack-64bit-ca.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ca.msi"
        "TortoiseGit-LanguagePack-64bit-zh_CN.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-zh_CN.msi"
        "TortoiseGit-LanguagePack-64bit-zh_TW.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-zh_TW.msi"
        "TortoiseGit-LanguagePack-64bit-cs.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-cs.msi"
        "TortoiseGit-LanguagePack-64bit-da.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-da.msi"
        "TortoiseGit-LanguagePack-64bit-nl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-nl.msi"
        "TortoiseGit-LanguagePack-64bit-fi.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fi.msi"
        "TortoiseGit-LanguagePack-64bit-fr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fr.msi"
        "TortoiseGit-LanguagePack-64bit-de.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-de.msi"
        "TortoiseGit-LanguagePack-64bit-el.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-el.msi"
        "TortoiseGit-LanguagePack-64bit-he.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-he.msi"
        "TortoiseGit-LanguagePack-64bit-hu.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-hu.msi"
        "TortoiseGit-LanguagePack-64bit-id.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-id.msi"
        "TortoiseGit-LanguagePack-64bit-it.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-it.msi"
        "TortoiseGit-LanguagePack-64bit-ja.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ja.msi"
        "TortoiseGit-LanguagePack-64bit-ko.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ko.msi"
        "TortoiseGit-LanguagePack-64bit-lt.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-lt.msi"
        "TortoiseGit-LanguagePack-64bit-oc.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-oc.msi"
        "TortoiseGit-LanguagePack-64bit-fa.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fa.msi"
        "TortoiseGit-LanguagePack-64bit-pl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pl.msi"
        "TortoiseGit-LanguagePack-64bit-pt_BR.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pt_BR.msi"
        "TortoiseGit-LanguagePack-64bit-pt_PT.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pt_PT.msi"
        "TortoiseGit-LanguagePack-64bit-ro.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ro.msi"
        "TortoiseGit-LanguagePack-64bit-ru.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ru.msi"
        "TortoiseGit-LanguagePack-64bit-sr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sr.msi"
        "TortoiseGit-LanguagePack-64bit-sr-latin.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sr-latin.msi"
        "TortoiseGit-LanguagePack-64bit-sk.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sk.msi"
        "TortoiseGit-LanguagePack-64bit-sl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sl.msi"
        "TortoiseGit-LanguagePack-64bit-es.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-es.msi"
        "TortoiseGit-LanguagePack-64bit-sv.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sv.msi"
        "TortoiseGit-LanguagePack-64bit-tr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-tr.msi"
        "TortoiseGit-LanguagePack-64bit-uk.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-uk.msi"
        "TortoiseGit-LanguagePack-64bit-vi.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-vi.msi")
sha512sums=('4be7ebe9f220e5d3859124e9079b474222a8bd1afbb66eae6635f1af1ce7dc288a5ef9c3289d0ebb8c895aaaff7e107801905bb70560012d79888a089d00da68'
            'd0bb42f1641431bd5e6a678818e777b11d0efe6780549b78f620f6278b7ffa5e814ab58464295fda9ebc612d72977e60ab2e2f9586422e11aac269e115421463'
            'c945b3bf5b5b1df7b3259b7c1d39ff4a573c1acfbf9c1291c70ea4f161d56b999b0aeb7e6646d65c960a496ea67feec2b4e92b79f756856353eeb6338a50fadd'
            'cb1987fc1887ce226646195176538d504614faca735fbe5bac64da4808bbcd17a10250c445309f13cd0b0f65d3a8dd475dc36874bb2d004dc16967edf966fd7d'
            '75214753ca35aa862a3b698b75dfdcd8191ce8884d2df6180b7ed0c129fbfc4c05ed265d5713df52da017b379fcff57b31d1f10ac490650919091904fdf5e6ad'
            'b4cbaa555fcec79b1040d316c30bd51b6a4ffdc7d8e052183d36708a2daef11fb9413478b71b772b5575effbc1d35b23a90f857ada7a045aacced18339719385'
            '76f3b94de5da180ed6a27bad1adf52dae1cbfc338d33abfc06c2ce8f71cc85e2a0f77578ea8a50ff0c8b10e90c986804b78b4c67dfe84a51b3f401b100ce79f6'
            'a87409f01a743be83a0646748eecc451f8bde1549f0139a8706866c0897c85ff9d2e68052b21637b5c5f9f247f5c0522140027635eb1f3f6f5be77eab09453f2'
            '30954473f28c9e570ee6aae0fa542c1981ffa3ffcc3c74430009a01781594959a8e41fa7ae117fbd6f5c12f0fd1d2e96a19cb6d9dc93537a9ad6a47a01a28d5f'
            '1c63de38bb92e6d1c88a4befe331228bb77371bcba950a68b68efc11ba5cfd262c21847db17dbeda552db991c5cdb08f39c3e599551ebcb913d12e82c1afe424'
            '3e65de3973c43ab9df88373f7937c92a5c75690589c3dddcabcca1efb7e25d8823eebd2d1067dbe8b9c84042414a12dade84a9456da799e97917d9dab3b09cae'
            'b0546296643d2f0a47859d1e8ac510a15d7e77f8c18432ee793d23240de5a68780217e41ad21ffa6ad1e64234e15ecf5abfe09af9de91c2b53d30d3899782f86'
            '58e5cd00d2107a262966e7bbaa9547affd3a09bf9405e6292dbd721f196273169b7e7153a17132fd86a1c6a4306ff651309e08d7772d5e8b17b9b33e5774e95a'
            '5d3f5a881e3811920225875eb9bc898a114c709eab93049a5e66c33653eb0101a7218442d1a9a2e9e543c5cf59dcede4822ed3d62d174bdede80fc01bc7bbb15'
            'a615b73892d16483a4182c3608b0f8debf5db7cf15637e4fce6e78da669603db866b2b2a7336b060b6225cbd88f66790455bc7cb07d9f5d97c24f7bbfbbfe870'
            'ddea6f420165eda0a1856c86340fc93f6cb69d788bac7dba42e17ed1ec5fb0b9ef389cfb9636a81fe459c4988188a7c3ea51cd331658ce24c99602201842e8da'
            '2b96f3a1e32b573d05aa4ca6453aaa667b7d4149d1b61daef1d2b1c0c01fc1c3cdc16cf8a7ca4735d1d70ec0e98e39bc60a768fba4ad5a63d177828e3333574a'
            '8c9e17cdb415f34b6eb3a84e44adf19615133234f2dac9a95db048f6ae7d8432b1185c258832ae78a3cbb01702c03a141c92bf8ce895515d03728378b81fb622'
            '17aa37f30b7d807f088f08068ec2cf76085882eb6dd5cd5f3cafffdb4f4e7be878187e8132906fc636be6ebe81101b7cd0ce1e2d68ae72e021b57579cf9a25bc'
            'd24a365ddbfdc88ea67e60a05463b06c2a1b1f91a9d98c53c0839fee1db3b24d1760da27e45866e6c48d83faad51aca0d1a4e40af03ad91570a341ec6bea24e0'
            'fdfe9857ec2edc820ee3a2f8108d088fabcf61c84bd30de90e117770ad0279fd31ccbdc94cf0176660513dafdc95db2ac7b5b6308baf5241f3da6952ec1aed10'
            'cd4b22fdd880e49ea104dc08dfe7bf31bd09e3991194f356cf0298eb24afd62b5ebea73d374b702065f28271298f8d8cca5db3e29817f633b870c2d3742413bd'
            'a40d448885566b73fa6f7644658713c5065cd5ec51c379b6db0bfa358e69ab10e99bb1fdfb2f435df8bad07ac13152379862c248e25a08d7defba89d1ff910ab'
            '7baa8663774adb090489f8642e543708fb9634e140aa7f6cb87d1a2bace4eee7a65612934003526702d0c43f8cecc7e41f7f8b14c360324bc28fc6ece23dd3a2'
            '8324b698ce781481ab589e6f29ae43c829bb9fdae26cf2f1a40770d689b42e97d7165c4dd7cfa08fef9120f66b50bda57cee32702928e2033129d73b03a6d4ac'
            'ebae611e6787fce738ef8c435e3e1b759b67f651de398b95c612b2e61b8d79ff9e0acd3ad307f39a7daac9c31883cd7450b10d3b0c0dd4160cc7d5b7f1fac52f'
            '8366c4b0d42a57ac83c8a313f656c1a3f1e4852dd322b18581d67e47079412db292343c304aa495fcea552b2d68d6583fb88e7720142ac23c896a1fa2fd62123'
            'ef38211c5e56bf1d8df27e5c8d3ed51d665727865a06be15d7923d34554da0205d1e90b784ce4f46288b9b554706438a504a8838247d8a153c01bce816d6e23b'
            '76776e4fd5f6cf8f4d9fe4503b9de60078052ebedfbcffdfd68c6e8847d324ac77fb70db248f6845fc189b56b491cefd5816fa8567e36c53a2f9f7db33cead95'
            '7e66661566a799db604de7b85a283534d466438b8eaf7343e110b2476d4e933765a52293f3f96b5fd8b6764209dc4fa508af77d76c9fd758757a55b13d76b036'
            'e794660953590d167ac12dfc844489094a63e50038489090b4813d8bea37f0e739b781e785bef6031e5ddffc86987c94793f880a537394c2dc211261d7efcf8c'
            '689de849229603aa8a163e1ed81c9c2c416fa04cf249e2b4f24a2c5f29297bc74ee438795acebbda10e5bae3bb50e1c465134be1bec245aafe52e9ff36cef2a7'
            'dcf839a3e96a7eb581890351177e17dcfbabc8db0352aa1174b84d203396265ca4d70c735c4294afe920aa125b0565d1198ba6e99351f541d17b8858944b28de'
            'f8937ebe99422071cc0214d5cab69c6229c40e26417259fe615d8e9e339660fb4096713c2e75d0fcaa085968057b12e2c459c252b93abcf66ee649e8a855385a'
            'f10597c5176f3fd401a013b7d3fe04e85e059c59bde7b0dcec4a19160cae52be64e86086b24f4c6872a2fd1a03773082530245171ce82207160b378f5bb6906b'
            '24c4fbd7cae528bc06569fe01660514bedd0b5cdadc17e45d0ff686d4972e0d7384458b4a83c3cf548e23e13d8b6d275171ef1cf2bda6e05766039d55fa297d4')

_lc() {
    local d f n

    for f in "${@}"
    do
        d="$(dirname "${f}")"
        f="$(basename "${f}")"
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${d}/${f}" "${d}/${n}"
        fi
    done
}

_rmmsdll() {
    local ms

    ms=("msvbvm[0-9]+"
        "ucrtbase"
        "mfcm?[0-9]+[a-z]+"
        "msvc[rp][0-9]+(_([0-9]|codecvt_ids|atomic_wait))?"
        "vc([ao]mp|corlib|runtime)[0-9]+(_([0-9]|threads))?"
        "concrt[0-9]+"
        "pgort[0-9]+"
        "api-ms-win-[0-9a-z-]+")
    find "${1}" -iname '*.dll' | grep -Eif <(for m in "${ms[@]}"; do echo "/${m}[.]dll$"; done) | xargs -r rm
}

prepare() {
    local f
    for f in *.msi
    do
        rm -fR "${f%.msi}"
        /apps/lessmsi/lessmsi x "${f}" > /dev/null
    done
    _lc "TortoiseGit-64bit/SourceDir/Program Files/TortoiseGit"/*
}

package() {
    depends=("app-tortoise-overlays")

    local a="${pkgdir}/apps/${_realname}"
    mkdir -p "${a}"
    cp -R "TortoiseGit-64bit/SourceDir/Program Files/TortoiseGit"/* "${a}"
    cp -R TortoiseGit-LanguagePack-64bit-*/"SourceDir/Program Files/TortoiseGit/Languages"/* "${a}/languages"
    rm -R "${a}/common"
    _rmmsdll "${a}"
}
