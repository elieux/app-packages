# Maintainer: David Macek <david.macek.0@gmail.com>

DLAGENTS=('http::/usr/bin/curl -qb "" -RfLC - -o %o %u')

_realname=ltrdata
pkgbase="app-${_realname}"
pkgname=("app-i686-${_realname}"
         "app-x86_64-${_realname}")
pkgver=2016.02.26
pkgrel=1
pkgdesc="Collection of small and useful freeware utilities by Lagerkvist Teknisk Radgivnings"
url="http://www.ltr-data.se/opencode.html"
arch=('any')
license=('custom')
makedepends=("unzip" "curl")
provides=("${pkgbase}")
options=(!strip)
source=("exefiles.zip::http://www.ltr-data.se/files/exefiles.zip"
        "exefiles64.zip::http://www.ltr-data.se/files/win64/exefiles.zip"
        "scripts.zip::http://ltr-data.se/files/scripts.zip"
        "scripts64.zip::http://ltr-data.se/files/scripts.zip"

        "checksum.zip::http://www.ltr-data.se/files/checksum.zip"
        "coordtool.zip::http://www.ltr-data.se/files/coordtool.zip"
        "netcheck.zip::http://www.ltr-data.se/files/netcheck.zip"
        
        "devio.exe::http://www.ltr-data.se/files/devio.exe"

        # installers
        # "zerodrv.exe::http://www.ltr-data.se/files/zerodrv.exe"
        # "imdiskinst.exe::http://www.ltr-data.se/files/imdiskinst.exe"
        # "ImDiskNet.7z::http://www.ltr-data.se/files/ImDiskNet.7z"
)
sha512sums=('3172bfe758cb04c937ed31c1ed2ce920e843d9d37a9c31e6c29be3b657452f08b5ad4acf3963ea42bfb06cf1fede9bb57ee50c41e5dcd59853b4d7d8112faf75'
            '97b19a377595a47deb236431a03432c6057c40b88a3b51343a54b71ea9b8f0a792dfcdd34d82d45b53718b3b95fbf4cc41539031af5c1b4ce0395b444f9d0959'
            '353feedf3c257eb46bd8f81d30e1c6697db2b13cfac25a0f0552fba277854c89cd299cb73d3d8f172b5cc252934be339fc890541b3f699a020a36d41ff52fcc5'
            '353feedf3c257eb46bd8f81d30e1c6697db2b13cfac25a0f0552fba277854c89cd299cb73d3d8f172b5cc252934be339fc890541b3f699a020a36d41ff52fcc5'
            '1e39b9a75333516ad2e831971a7e0e1c00146cd7428bea64bbb2aa12924451b6209afb99b784cd65c7a6c1bf7197e060f1959c6940fe7db368d81aa9a83a5136'
            '7c2a0fa7055707550b53970ab88b4f331b52fc2b811f39e4e99881cf084a73ffb21049e6ab2b12183e6e9ff91ae7df256dbf0d169fb0f5d89acfdbaa8efa6138'
            '352d4f9bc1b2d6fe44375e71f36abb3dd690632ce6d64fff7915bc2979fe1613f18243f53d4fc3b3df4b994648acdb4e403387d3e5b8de80e8af486734322a69'
            '7933a93a7724876adf1f65d57323b7e1d7c64df2c2a689240174308ca6bd0a456b79245697f84d4626b85099190843ae2fbd678bb638007fcc8ebd49c563b4ba')
noextract=("${source[@]##*/}")

_lc() {
    for f in "${@}"
    do
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${f}" "${n}"
        fi
    done
}

pkgver() {
    #find . -mindepth 1 -maxdepth 2 -name '*.exe' -printf '%TY.%Tm.%Td\n' | sort | tail -1
    find . -mindepth 1 -maxdepth 1 -name '*.zip' -execdir bash -c 'unzip -l "{}" | tail -n +4 | head -n -2 | sed -r "s/[ ]+/\t/g" | cut -f 3 | tr "-" "."' \; \
      -o -name '*.exe' -printf '%TY.%Tm.%Td\n' \
      | sort | tail -1
}

prepare() {
    for f in *.zip
    do
        unzip -o "${f}" -d "${f%%.zip}"
        _lc "${f%%.zip}"/*
    done
}

_package() {
    a="${pkgdir}/apps${_apparch}/${_realname}"
    mkdir -p "${a}"
    d="${pkgdir}/docs${_apparch}/${_realname}"
    mkdir -p "${d}"
    for s in $1
    do
        s="${s%%.zip}"
        u="${s##*/}"
        u="${u%%64}"
        echo "${u}"
        find "${s}" -regextype posix-extended -regex ".+\.(exe|dll|exe\.config|cmd|vbs|ps1)" -print0 | xargs -0 cp -t "${a}"
        find "${s}" -regextype posix-extended -regex ".+\.(txt|cnt|hlp)" -print0 | xargs -0r cp -t "${d}"
    done
}

package_app-i686-ltrdata() {
    _apparch=32
    _package "$(find . -mindepth 1 -maxdepth 1 -name '*.zip' -not -name '*64*')"
    cp "devio.exe" "${pkgdir}/apps${_apparch}/${_realname}"
}

package_app-x86_64-ltrdata() {
    _apparch=64
    _package "$(find . -mindepth 1 -maxdepth 1 -name '*64*.zip')"
}
