# Maintainer: David Macek <david.macek.0@gmail.com>

_realname=skype
_apparch=32
pkgbase="app-${_realname}"
pkgname=("app-i686-${_realname}")
pkgver=7.32.32.103
pkgrel=1
pkgdesc="P2P software for high-quality voice communication"
url="http://www.skype.com/"
arch=('any')
license=('custom')
provides=("${pkgbase}")
options=(!strip)
source=("SkypeSetup.msi::http://www.skype.com/go/getskype-msi")
sha512sums=('e50c6b9b5c6c935f1996165c12084421574ab6e2aefa7e39c15fb807238684c2cd7e35ab0ad1afa01fa7d58b0c8169c0520b7d611acf1e642bf44aaedd9aba80')

_lc() {
    local d f n

    for f in "${@}"
    do
        d="$(dirname "${f}")"
        f="$(basename "${f}")"
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${d}/${f}" "${d}/${n}"
        fi
    done
}

pkgver() {
    msg2 "Starting build() to determine package version :("
    build > /dev/null
    b="install/Program Files/Skype/Phone/skype.exe"
    if [ -f "${b}" ]
    then
        b="$(cygpath -wa "${b}" | sed 's/\\/\\\\/g')"
        wmic datafile where name=\""${b}"\" get version | grep 'Version' -A 1 | tail -1 | tr -d ' '
    fi
}

build() {
    msiexec -a "SkypeSetup.msi" "TARGETDIR=$(cygpath -wa "install")" -qn
    attrib -r //s
    s="install/Program Files/Skype"
    _lc "${s}/Phone"/* "${s}/Perfmon"/* "${s}/Redist/Skype"/* "${s}/PFiles/Skype/Browser"/*
}

package() {
    s="install/Program Files/Skype"

    a="${pkgdir}/apps${_apparch}/${_realname}"
    mkdir -p "${a}"
    cp "${s}/Phone"/* "${s}/Perfmon/performancecounters.mam" "${s}/PFiles/Skype/Browser/skypebrowserhost.exe" "${s}/Redist/Skype/skype4com.dll" "${a}"

    d="${pkgdir}/docs${_apparch}/${_realname}"
    mkdir -p "${d}"
    cp "${s}/third-party_attributions.txt" "${d}"
}
