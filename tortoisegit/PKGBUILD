# Maintainer: David Macek <david.macek.0@gmail.com>

_chocover() {
    # 2.16.0 -> 2.16.0.0
    echo "${1}" | sed -r 's/^([0-9]+)[.]([0-9]+)[.]([0-9]+)$/\1.\2.\3.0/'
}

_realname=tortoisegit
_choconame=TortoiseGit
pkgbase="app-${_realname}"
pkgname=("app-x86_64-${_realname}")
epoch=1
pkgver=2.18.0.1
pkgrel=1
pkgdesc="Git client implemented as a Windows shell extension"
url="https://tortoisegit.org"
arch=('any')
license=('GPL2')
replaces=("app-i686-${_realname}")
makedepends=("app-lessmsi")
provides=("${pkgbase}")
options=(!strip)
source=("TortoiseGit-64bit.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-${pkgver}-64bit.msi"
        "TortoiseGit-LanguagePack-64bit-sq.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sq.msi"
        "TortoiseGit-LanguagePack-64bit-bg.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-bg.msi"
        "TortoiseGit-LanguagePack-64bit-ca.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ca.msi"
        "TortoiseGit-LanguagePack-64bit-zh_CN.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-zh_CN.msi"
        "TortoiseGit-LanguagePack-64bit-zh_TW.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-zh_TW.msi"
        "TortoiseGit-LanguagePack-64bit-cs.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-cs.msi"
        "TortoiseGit-LanguagePack-64bit-da.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-da.msi"
        "TortoiseGit-LanguagePack-64bit-nl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-nl.msi"
        "TortoiseGit-LanguagePack-64bit-fi.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fi.msi"
        "TortoiseGit-LanguagePack-64bit-fr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fr.msi"
        "TortoiseGit-LanguagePack-64bit-de.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-de.msi"
        "TortoiseGit-LanguagePack-64bit-el.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-el.msi"
        "TortoiseGit-LanguagePack-64bit-he.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-he.msi"
        "TortoiseGit-LanguagePack-64bit-hu.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-hu.msi"
        "TortoiseGit-LanguagePack-64bit-id.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-id.msi"
        "TortoiseGit-LanguagePack-64bit-it.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-it.msi"
        "TortoiseGit-LanguagePack-64bit-ja.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ja.msi"
        "TortoiseGit-LanguagePack-64bit-ko.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ko.msi"
        "TortoiseGit-LanguagePack-64bit-lt.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-lt.msi"
        "TortoiseGit-LanguagePack-64bit-oc.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-oc.msi"
        "TortoiseGit-LanguagePack-64bit-fa.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fa.msi"
        "TortoiseGit-LanguagePack-64bit-pl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pl.msi"
        "TortoiseGit-LanguagePack-64bit-pt_BR.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pt_BR.msi"
        "TortoiseGit-LanguagePack-64bit-pt_PT.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pt_PT.msi"
        "TortoiseGit-LanguagePack-64bit-ro.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ro.msi"
        "TortoiseGit-LanguagePack-64bit-ru.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ru.msi"
        "TortoiseGit-LanguagePack-64bit-sr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sr.msi"
        "TortoiseGit-LanguagePack-64bit-sr-latin.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sr-latin.msi"
        "TortoiseGit-LanguagePack-64bit-sk.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sk.msi"
        "TortoiseGit-LanguagePack-64bit-sl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sl.msi"
        "TortoiseGit-LanguagePack-64bit-es.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-es.msi"
        "TortoiseGit-LanguagePack-64bit-sv.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sv.msi"
        "TortoiseGit-LanguagePack-64bit-ta_IN.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ta_IN.msi"
        "TortoiseGit-LanguagePack-64bit-th.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-th.msi"
        "TortoiseGit-LanguagePack-64bit-tr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-tr.msi"
        "TortoiseGit-LanguagePack-64bit-uk.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-uk.msi"
        "TortoiseGit-LanguagePack-64bit-vi.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-vi.msi")
sha512sums=('b3f92c3a7938144e4989c57440c8b0808245b156eb87bcf02ed3e1b35604b4845d41e05b3dc487e4e8ae9880676ee6e9b45de3e0a8d6c78468617c99e33af8a7'
            'd8fba0db6a66f884be5b9d502fc17dff7f9005898520ec362164339514a6315f1e4d1c9939cfceab6e1f29c38a6cd0f3ad23a0a4a3224c96a9a760afff20c231'
            'addeae09571afc7ba8ac3fd931fd5e7af462b8a20e6b69fa32098b73556182623f0c6eee9b8ddefb8ea98e948b6f5b56127d053a76e2d67491fd9d698880ab60'
            '3e3c90e08a56cd515ff89ca914297192c88dc85658c843d7c89e2529a08f173ae641b3d4e92aedda07e3978be5ca2c43c84fe48ea3a5e847e6d495fbdce0490c'
            'c9ba2e9cad83746f9fc4790a4205b26eec72a5fee4880da048084dbe72db934081ee2bd77522b4ccf03a742e5853286b51719899cb60de082885b83474261065'
            '46d8766d19f4eaf01a8989da9bb53ac41635277908fba999d5cc5c2b1ed0ebe8dcd6ce67357bec9c379c9bd6261538fcfd1a07ced643764ab4256e583aaf8bc8'
            'e054f3fb75209a5aa03485fdd8a397b74822891a509c76558fc1efbcf9a15594419924fa522c09e8592a8c4f8de4171cfd419616af6f14a6a808f4051a69732e'
            'de745dc0fd094078a37a5798a5b66a8827b8640e06476fbebd37d7c708ea8718fa7e84f3f90666a9dcd4d3f6f15d71e2003450cfc5ef2a9d0b32efbff5ce780a'
            '222b019d008a6882c67dcb1d1d27e6b67c9414c07bbf812960dec2f6d240cef106ed3809d74774cf07d8a6f31f4f6c417fedfca9cec30336e7232f4f6b4eea37'
            '11e85eb4536976ccf5251f8bf62630127f0ea195d726572dce3abf79a09f8bf9e5ef3237ab05b75115d4899229e048cf8bfb516640005ca3d3b0f004b2ca4c5d'
            '16f1f3ff3f353b3d009a6f5ee0a4fa5b638c52de71ca9ad7a9bf13708495f913f771ae8cfd1486cdad4723d2dd0be7578a11cd6af0495d25df144897c75bfffb'
            '3d3f49362af962be87a72e19c462a6dd11e97f33ec3e8f3ef235c9b17a7ca04b8cc9ba0ab9368807a176c98e3aef646b2ccaa03d0ded92f716df1d678675584c'
            'b262aa0abb161140d44eb17d56825fc8af6a42256181fbba2b354d27a64d76b61cb0e2ab5a8ffee883f58e52693cc941167c36319f58f1d8de3687057ba820ee'
            '3b47df79997c63a522d7a9c1fbc69587ca5b1aeccf3f9d60f746711dab683a73f21334a11e8e92aa31d4b5521128ab67567a9c49c37f364337412ee3c2bb3cd3'
            '0c0e361fdcb6b57028abda2ddae06b79ff3c89419b3355d8a89183bb887d48f60e0ef3ce221f337e15586b0afb2e87b8d8b006f89e643ed48cd90dc24aba708f'
            '3041caf5ee4f82ae31cab662fb1e68ae6e42a843cd6221d72eb56746af0b9e723d5be6e95eca6bd3bb78f5aa97cf23e929088e1ce63ba4b8c5f981bb46ddf34f'
            '097091946f58cbdc100e104e5b5b2ac471b1b85b466ba2aea624d23a84f9ce6e3e1011df46e30e41bf17c457e878d0fcbde3dc784acdc903eaabc46c7fe90df3'
            'f3e765fab625100bb349db74e142b0c2f23b43352438cb5d3cd6a4adb4f625abf0132f522d6f844b69c2a289573ff8ce9881a3554f161477c06429e3d8ffd5f9'
            '4c691cbaab0434b204ea480fd81f7bea056a858e6f38029757294494e903eeb4f24ea39776a2477ac138413d3279da180c1512acf40b65682740490a7438a84b'
            '37fc018f96879ce9f95c43df21fd0f7f836146488925bbed6d0a1ea20eb6795fbc106c2b8311714b6390c70269147cff32fb1ee3066c6503d20fd72446145ba4'
            'dc5f529539f45fcba6299798443966be2e3dbbdc8a98ef52d219ea955be4a54080dae023750caccf3e49aaff8c4b21d4c3d731210e2cbb5250d17e9b134e2662'
            '3d17d4aa4e14dbd6a1c4c63877c5718c87ababa77361acbf0d2814de89e7abf88d40fcb432d5424f46ced0c09a4e49ae743b6352227d4059c7fe0182a55f2be2'
            '439251fde5f323680a123fa7a93a7ad8e50cb92f9f97fa6c81b58cbc7e7334c79ef02514a3b8dd5881a9aa983f8a7f1189822f000c8a07376039470cfe508ffb'
            '715e3386562b6e924d041b11aa32bc09b8a416b40812675258a8455d1def60c87b2c88f255854cb7725d53442a6ab13215b76751168b683a5984f41b537383da'
            '8ad0d39ce359762e6c7f81c5e550572556d973e42e769f3193072507b2d64b3df2f7d642420f4c8ee05a51228ae138f02205f6c3873d15d75311847d43a2d593'
            'c4a83494b8a782b7c4ab177a46fe5762dbfbd788d374fae5b135f5bd0d9f2d65b665d3d07b5876f677303421dfc280935b117c8c3ed1dbf9d7fb06ce3d6b0957'
            'cd853f451b024bf55637d2354e1659b9619dbf6886e328278faf32823fe655b273bc1b7ea711ad7ef02bd435a26e3af496905a2603142883654ce17552a572fa'
            'b985ae14ae05bd2276169c9de5cdf8d2eaec02cb5140566ec5feb66ed496ae4b3a9385c49f4696e7a2a04a3ee89d2e66aae6c8716e2a98d86e767fc1edbda70a'
            '7d2f4c8902eec71d4de708ce18901501f40dfe10d05edaf8fad93c1c71c87df504a9eb56d21d55d39f4f702fce45f96079f82d93ce2087fadaf78d8d63cf959b'
            '4e7a02f877ac69dc30e4f6f519db74e28dc6bb06d3197ca4913b7d0bb74db264b5c2cf3c0905d6df6e3f09c17fe751a4274120e9666258b24278e30833316892'
            '656562b2ef20d3acb62cfba01a72896bbc2fa82021ba82f16cc54692bcac1c1e35c9482289da666ec162f2adedc0003e73ae646d1b9b5c638ff97f5ba29bd108'
            '3b06d9feb8c9fadd25172059940d4b7fccc57f39a3b9f429dcb3b40f644e81b03cc6a8ea0050aa6928f58adbf4127f75d5eeb5f4e9ae8e07c812a7c3fdb62bdd'
            'f0a09e31ab85ba629510ebdacfcba5341ccebc6a3f370d82a4e96a2b5873735b98cef80371c9aa855298035642196fa76c693e91054d8b0ddc59c7733b5783f6'
            '3390edf5b9db75b3cce6e2ee6cfc421abad7b3cb284c3dfcefe25038d2ee598291a35e544df92ead9d4ca9ae5c365a582682b9ddd97adc7ec26ac4303fffa2fc'
            '4f8f405abc600681768f78d132835288f8e8f8f313e590352604d829b9b242832a36c8aabfb894e7b339ea673da613017a28c06e498cf354ff963f5dbd1d63d4'
            '8db0ab6e2d965865ead39f801554df9d4e7734f28995bea18176c101f55e0f4807285da357067d1a2f2fb7474b2866a9d79814f9f1aafd8b68f21b6e766e9ac1'
            'db71b1b5a1a9bddace885d40d0a677ce765f6118a962532bbfbb98f2a762ebfbe5578a4b59bfaa5c4b69c813413ec3fc4796ebcad2a615bc6a15bca54437337b'
            'a317835348d3f5804a2652fbb1838e187b27a61aa65af4067dcc6d518b18352c569af02eb1cf0df079c73861c4f7637844dc77f4713982309fc6f12637460da6')

_lc() {
    local d f n

    for f in "${@}"
    do
        d="$(dirname "${f}")"
        f="$(basename "${f}")"
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${d}/${f}" "${d}/${n}"
        fi
    done
}

_rmmsdll() {
    local ms

    ms=("msvbvm[0-9]+"
        "ucrtbase"
        "mfcm?[0-9]+[a-z]+"
        "msvc[rp][0-9]+(_([0-9]|codecvt_ids|atomic_wait))?"
        "vc([ao]mp|corlib|runtime)[0-9]+(_([0-9]|threads))?"
        "concrt[0-9]+"
        "pgort[0-9]+"
        "api-ms-win-[0-9a-z-]+")
    find "${1}" -iname '*.dll' | grep -Eif <(for m in "${ms[@]}"; do echo "/${m}[.]dll$"; done) | xargs -r rm
}

prepare() {
    local f
    for f in *.msi
    do
        rm -fR "${f%.msi}"
        /apps/lessmsi/lessmsi x "${f}" > /dev/null
    done
    _lc "TortoiseGit-64bit/SourceDir/Program Files/TortoiseGit"/*
}

package() {
    depends=("app-tortoise-overlays")

    local a="${pkgdir}/apps/${_realname}"
    mkdir -p "${a}"
    cp -R "TortoiseGit-64bit/SourceDir/Program Files/TortoiseGit"/* "${a}"
    cp -R TortoiseGit-LanguagePack-64bit-*/"SourceDir/Program Files/TortoiseGit/Languages"/* "${a}/languages"
    rm -R "${a}/common"
    _rmmsdll "${a}"
}
