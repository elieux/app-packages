# Maintainer: David Macek <david.macek.0@gmail.com>

_extract_subdir() {
    local _file="$(get_filename "${1}")"
    local _dir="${_file%.*}"
    if type bsdtar | head -1 | grep -q 'is a function'
    then
        local _original_bsdtar="$(type bsdtar | tail +2)"
    fi
    bsdtar() {
        local _extra_args=()
        if [ "${1}" = "-xf" ]
        then
            mkdir -p "${_dir}"
            _extra_args=(-C "${_dir}")
        fi
        /usr/bin/bsdtar "${_extra_args[@]}" "${@}"
    }
    extract_file "${_file}"
    unset -f bsdtar
    eval "${_original_bsdtar}"
}

download_http@subdir() {
    download_file "${1/@subdir:/:}"
}

extract_http@subdir() {
    _extract_subdir "${@}"
}

_realname=ltrdata
pkgbase="app-${_realname}"
pkgname=("app-x86_64-${_realname}")
epoch=1
pkgver=2021.11.25
pkgrel=1
pkgdesc="Collection of small and useful freeware utilities by Lagerkvist Teknisk Radgivnings"
url="http://www.ltr-data.se/opencode.html"
arch=('any')
license=('custom')
replaces=("app-i686-${_realname}")
makedepends=("p7zip")
provides=("${pkgbase}")
options=(!strip)
source=(
        # ImDisk Virtual Disk Driver
        "imdiskinst.exe::http://www.ltr-data.se/files/imdiskinst.exe"
        "devio64.zip::http@subdir://www.ltr-data.se/files/win64/devio.zip"
        "ImDiskNet.7z::http@subdir://www.ltr-data.se/files/ImDiskNet.7z"

        # Zero and Random device driver
        "zerodrv.exe::http://www.ltr-data.se/files/zerodrv.exe"

        # others
        "exefiles.zip::http@subdir://www.ltr-data.se/files/exefiles.zip"
        "exefiles64.zip::http@subdir://www.ltr-data.se/files/win64/exefiles.zip"
        "DotNetFileTools.zip::http@subdir://www.ltr-data.se/files/netcoreapp3.1/DotNetFileTools.zip"
        "MathTools.zip::http@subdir://www.ltr-data.se/files/netcoreapp3.1/MathTools.zip"
        "SystemTools.zip::http@subdir://www.ltr-data.se/files/netcoreapp3.1/SystemTools.zip"
        "MailTools.zip::http@subdir://www.ltr-data.se/files/netcoreapp3.1/MailTools.zip"
        "HyperV.zip::http@subdir://www.ltr-data.se/files/netcoreapp3.1/HyperV.zip"
        "xmlvalidate.zip::http@subdir://www.ltr-data.se/files/netcoreapp3.1/xmlvalidate.zip"
        "QuickBrowser.zip::http@subdir://www.ltr-data.se/files/netcoreapp3.1/QuickBrowser.zip"

        # secret
        "scripts.zip::http@subdir://www.ltr-data.se/files/scripts.zip"
)
sha512sums=('5e6a38df7cc8abdc54a7bf17b286cb14ae52c402592ba659a3458a461f5bdfa1beae8890c66dd333ab7d2622f946a51a78a2076ece891ddd84fe4b7cc7fd4185'
            '156b163fdc038bb9924b2dde4ed1b2416fd09d2c0f0b8fd85a0f9a0d6b740be7daa0510ec4e7bded5573eda7d59510b859e33efe7b3d7b0dc2ce45bb95936bd0'
            '2ffbc129febee2667c54c068d04dff97aa6b6dcdcd828b0b8c3770d0133fd3e7390e067c16c86dfbcffc2a21c874622d415e04a8aa220bdd02665088c4f98929'
            '846acc5130f99dfb63d5a7d03f3f0628b327e1846907f87825a9e954cb3a9bd72681e9072dd07171ac06556cfeacc7be5a4172cbb8052fc45b45e5c0d31b2635'
            '97926b1a9fc8ad1cfad24fb367a213afa96f7e4129ffd4b0e52b6f9be167b06fb62296688312c9d075e3748adf9ae82e8812999971fc89ff3aa3aa2aa116e90b'
            '257e7eb32205706f05c13f36d5007901af14d28055f6925a1156b1a4a2fcda31c16b584328e52b46c9c30fa9d389cb893eca3267f1205ceac9c2ac775d8fa45c'
            'd228a63f0ea911603bc54015684730399f1381228f872f90be5046fc38e44270881e8f09d5d104b3da9188f77af9ee067f7c824397d5f4793ef7ffef77ffd54f'
            'a80a43915db3b4e66609b84e7ddc7891fbc6894e6d87ec445ea018070226ac1ec1ae7b0c33bc720048972a88a4f55d75fcbed1c80e567c7bc21cef844d7216dd'
            '9e50ac421909568305c9eeead7d0a9b7a8bed2226e18f0a2c016532b51a82a65d1fa696bf1e692cfd11f0797575343bbafcd5e930a17b90bf299713d42567898'
            '3553c501bd8f43da3530b241f7cf52e41f4648de136bab96e13f962f70bba6c011f2e47e9588490bc423b91a81ae628e8b454c269cbcd209499e315ae8341670'
            'cefaf78d68cdb220e5a01d1cdca70152d90b3083ae13907dffe26df05688b3c99ea84996b856dcb38263c534404e0b740732bebba8103b92895c4c8b7de1c529'
            '42e774f146bef0285a667094f8887cc3d773f9be3c2fbae3ad593bcb5bb61a5b8731ac96158e72791ab9683d9f61a11b5debab190f8e291ce9d027fb52cebfbe'
            '21b71877593ee77d4273f0d98862294d43e8981b30b427b08678eba70b8e1e1e3de439783a0b4f5e0d6b47996dc93ef85e8c3597b62a99b6392a569f3045fab8'
            '2f7c7011871898829ad1392a85c537ee6dfb2ea8f2eaa0619db1be4fbd0cf4c7239762d6d3c34772311e2e3440246fc6e6fe6116e92a358b340598eb05e0bdde')

prepare() {
    7z x -y -bd "imdiskinst.exe" -o"imdiskinst.dir" > /dev/null
    7z x -y -bd "zerodrv.exe" -o"zerodrv.dir" > /dev/null
}

pkgver() {
    find . -mindepth 2 -type f -printf '%TY.%Tm.%Td\n' | sort | tail -1
}

package() {
    local a="${pkgdir}/apps/${_realname}"
    mkdir -p "${a}"

    local d
    for d in $(find . -mindepth 1 -maxdepth 1 -type d | grep -v "exefiles" | grep -v "[.]dir$" | grep -v "ImDiskNet")
    do
        cp -R "${d}"/* "${a}"
    done
    cp "exefiles"/* "${a}"
    cp "exefiles64"/* "${a}"

    cp -R "imdiskinst.dir" "${a}/imdisk"
    cp -R "ImDiskNet" "${a}/imdisk/dotnet"
    cp -R "zerodrv.dir" "${a}/zerodrv"
    rm "${a}/imdisk/runwaitw.exe" "${a}/zerodrv/run64.exe"
    rm -R "${a}"/{imdisk,zerodrv}/*/{ARM,ARM64,i386,ia64} "${a}/zerodrv"/{win2k,winnet}
}
