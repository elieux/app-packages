# Maintainer: David Macek <david.macek.0@gmail.com>

_realname=tortoisegit
pkgbase="app-${_realname}"
pkgname=("app-x86_64-${_realname}")
epoch=1
pkgver=2.10.0.1
pkgrel=1
pkgdesc="Git client implemented as a Windows shell extension"
url="https://tortoisegit.org"
arch=('any')
license=('GPL2')
replaces=("app-i686-${_realname}")
depends=("app-tortoise-overlays")
provides=("${pkgbase}")
options=(!strip)
source=("TortoiseGit-64bit.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-${pkgver}-64bit.msi"
        "TortoiseGit-LanguagePack-64bit-bg.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-bg.msi"
        "TortoiseGit-LanguagePack-64bit-ca.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ca.msi"
        "TortoiseGit-LanguagePack-64bit-zh_CN.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-zh_CN.msi"
        "TortoiseGit-LanguagePack-64bit-zh_TW.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-zh_TW.msi"
        "TortoiseGit-LanguagePack-64bit-cs.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-cs.msi"
        "TortoiseGit-LanguagePack-64bit-da.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-da.msi"
        "TortoiseGit-LanguagePack-64bit-nl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-nl.msi"
        "TortoiseGit-LanguagePack-64bit-fi.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fi.msi"
        "TortoiseGit-LanguagePack-64bit-fr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fr.msi"
        "TortoiseGit-LanguagePack-64bit-de.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-de.msi"
        "TortoiseGit-LanguagePack-64bit-el.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-el.msi"
        "TortoiseGit-LanguagePack-64bit-hu.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-hu.msi"
        "TortoiseGit-LanguagePack-64bit-id.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-id.msi"
        "TortoiseGit-LanguagePack-64bit-it.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-it.msi"
        "TortoiseGit-LanguagePack-64bit-ja.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ja.msi"
        "TortoiseGit-LanguagePack-64bit-ko.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ko.msi"
        "TortoiseGit-LanguagePack-64bit-oc.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-oc.msi"
        "TortoiseGit-LanguagePack-64bit-fa.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fa.msi"
        "TortoiseGit-LanguagePack-64bit-pl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pl.msi"
        "TortoiseGit-LanguagePack-64bit-pt_BR.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pt_BR.msi"
        "TortoiseGit-LanguagePack-64bit-pt_PT.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pt_PT.msi"
        "TortoiseGit-LanguagePack-64bit-ro.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ro.msi"
        "TortoiseGit-LanguagePack-64bit-ru.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ru.msi"
        "TortoiseGit-LanguagePack-64bit-sr-latin.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sr-latin.msi"
        "TortoiseGit-LanguagePack-64bit-sk.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sk.msi"
        "TortoiseGit-LanguagePack-64bit-es.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-es.msi"
        "TortoiseGit-LanguagePack-64bit-sv.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sv.msi"
        "TortoiseGit-LanguagePack-64bit-tr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-tr.msi"
        "TortoiseGit-LanguagePack-64bit-uk.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-uk.msi"
        "TortoiseGit-LanguagePack-64bit-vi.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-vi.msi")
sha512sums=('29eefea723587e681dc1f9dbbeeaf4ec52788280c8000746aaf1b0b1209b8c576e740641d30534e60dd75db59d60bf8571490f8720caa664ce8c79296bb9ffa2'
            '6dff86bc1346234f4709ec0a2f1b16acf62a8f58a45cc42aaa6de89f0bd6b3ee4b5eed23bb9208b91acab0e916d6347011d395c8a539616d1aee324fee6f4671'
            'e80c6b9d074d8091adf06612af462baec89cd0b641c68df02c38406b9e15e5cf2e95cf67bf3a514c186e2970ee2942b5cbcf7be2740ef33a56ac1cc2d19030fd'
            'f91b7c491b4b612fb682f44c24c2cc1407bb4bc5289d809ea65efd5919c7db0c5284d1bd8714aa5786d5ead6fbabb83e68ee6618e21b6026509dc8fc6e2b484a'
            '4ecdf42c95bea0a3cab12e84b095fa24c243a8a0f7899bc4280729f18caac48f053684badd79804e7817b15c2c79fa5e3ec415d6e92a7e85d95f84ccf8a8ad1c'
            'a0e5b2b5b5bce046d3209ca27435dcce73073d26161df6e155bb161597919511e1bdee4fe76c7c7fe6c15546d659e343fc6c05ce2d509d1eae0f91826c08c678'
            'cb5b7c0d1694acc6e4ddac2904c110cd659761a377aba60174be287c1d6fc46b1e0505fe882617a44ab814be6611a2cf843b1560f50045320a1638144cec939c'
            'df7d0c177e4f3587286e6b97fda25275109eb37959f83480a77863346617725c88b49cc5b7c11f2393d3cba91bca17e5a072734bfd9306ee9e933f8d414a91e0'
            '3bcd9e72f11b117cf084edd47beb80c51f2d31a3d5cf2f4086f15e61b2ff15b85e0fe02f4ab7fc388b02d8760fa11975fc7b73b8d8f90f31daaae8a46a8ea9af'
            '3580f61219e363c8809c3c3724b5c6e4711cf5006ee648e005c197f3dfde57868f6622fe6519f1386fbca7630f05df94a28244a309952ab2fc26c5ab166e6903'
            '31719c82ca91959a46d03b1b589028c3b97684692f4f2145d9b204e5205660fe428ad2c42777f35a3fde02f9e8166f58b8f6c10cdeda8906477b90bc72b92634'
            '91bab169bb45217e0d2716bb69fb5865168ed16b184ddbe16b40f70f8040d19a62901ab3e397734e51f4c389de6fbb043cdef57b9c316b7c58a1fc8d045f445c'
            'c89590fac98fae09c613ea2aa860c42322f9746764689f7a2778bede498dcfdbbfe2597326aa5a81d9f65144b369edbad68ed1e248b686b312170f3ec415aabb'
            'ab3043ae9f58be9e1eb60b633e57e94ee9b6558bff8bf51fcb0200c45c531d40c665a62d1f147ea3c5412cd14d60fb20729fdf59de2497441256712533298bdb'
            '8d897edb69517ad74624ed7832e9510c30b263f7cf36b7310e337bbf48e133a9844faa3ddf1f8e8291f7ece091d360dc433b30462e3c988a18e4075453752b52'
            '9f473c77884c3a22485b2cb0dbe7dfdae96ed771e7a8e77ded3689d31d5b668314626d8132c77e8f44bef5c75007788769557e876a3e4ece0c36ad4cc053dcac'
            'b292977dbaade580d1ff27d7b802dc475357b30fc05850ec1dadac40bcca972f11d2bf1eba88aefced832272a25e804d4c54d737ab08e1cb3e19d098f6410237'
            '6a35fdf9e1ff0a0e2cd636b4d282b45064e6011525be3eed45c141af5d48b1b9b3edd965f28e257d0c8f7fbc1c22a8532ae3005fea817a6ebe53b31c7c1fc8f9'
            '5903d9ed0fabd1da43023a7d7d6f91b9bbd2af8f37f265a49d816a96b256f4501ba6a20ceb1b5bf22eff8c6669c84d6012b874118a6b4d2c3013eb6ae797e2ca'
            '576e60009d7f70f6129ed04a1c86ad57964d2f9ed14424173efe3afb8662261821f4577bf22f25f0fe213070dceb6805b3e7cbeb3441b868d2ff63cd9ce26e34'
            'c3fbcb82d4dd00320fe1d8ee2bda1cb3c58074d69672f4e3906ec91cfaba091811e0f4c6ff6bee2be78ff6bb7607db959247eb0bb0602a3a2264e06ed9cd756b'
            '27e97e39c7b935da50ac68cadafb6d5325fcff0da9087d5056836b4a9a2d04a1cf999ec8b6b38ce4058cec4ca63cedfcffe98ff1f3694b8b29e38a1b26b176ad'
            '33898155238b311aee78003ddc88bfe6c1b632e9021926132cf99bd88f08eb3bba93d84e48a31b058a579e393c3b7c8946e1c142801165606499454a2fe06c13'
            '3cbc0b90e9a977a44e06d1849751779c44ecf8daf699ea8c2f4d770551f13945b7ce555deed9d12b76d6827df0df9fbdad2b60e716ac05122b496be3b843a885'
            'aa1fe69fc34b876321db87e715f42e6fbfe9fe46e0105c21402e5609af8dfd62213ee51a47bd87531b81e944796155d1616a00915cb92869a0796d0486dc4973'
            '927161b46b4e0fe5cf010e4db7510553549485380a3bc193a8f5457deb0627588582ca07106aef507927b0358cf01037a9fae576c03c58c8a8ebefb1d30e4273'
            '9b78114b6afc2a4e88ad1a849e0c11dceb238fd60f62fa2f5088e782bb7ec502ed2d269ec9b7815579c4f5f8d9c8a45257a76488c999e6c51beb6cc1663e7894'
            'abcacc9e1976e3ae874c1ef79bb9e3889104af1dd462fbe6319e4453fc605ca7c897b0d384e8814ecb1519ad2776312b096398d055c948e730f8c1caeadcd143'
            '8e5a743f2fc2ad175a8ba7247bed93284ee3a0860900dbe975b61209730e28b2fc389f84ac2e8f0b3092e013602838243bd8c3a34b90dbf5dd9df3bdf5c6c371'
            '83a46efd1c0d739818c41ba18ae1ac9a09834189e5f26f01ec6fdf575af4e0477e1082c65acbb164201c9967f874db831a003aed51412df6962bd0edeb774cf1'
            'e55eed94906a76b127df859133dcfd5ed5bbd2be0b6118a726dc1bec8a74172db364476127d2b8320401d0228825cb4fa4101a9ba7a1177770752937e6611b9c')

_lc() {
    local d f n

    for f in "${@}"
    do
        d="$(dirname "${f}")"
        f="$(basename "${f}")"
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${d}/${f}" "${d}/${n}"
        fi
    done
}

_rmmsdll() {
    local ms

    ms=("msvbvm[0-9]+"
        "ucrtbase"
        "mfcm?[0-9]+[a-z]+"
        "msvc[rp][0-9]+(_([0-9]|codecvt_ids))?"
        "vc([ao]mp|corlib|runtime)[0-9]+(_[0-9])?"
        "concrt[0-9]+"
        "pgort[0-9]+"
        "api-ms-win-[0-9a-z-]+")
    find "${1}" -iname '*.dll' | grep -Eif <(for m in "${ms[@]}"; do echo "/${m}[.]dll$"; done) | xargs -r rm
}

prepare() {
    for f in *.msi
    do
        rm -fR "${f%.msi}"
        /apps/lessmsi/lessmsi x "${f}"
    done
    _lc "TortoiseGit-64bit/SourceDir/Program Files/TortoiseGit"/*
}

package() {
    a="${pkgdir}/apps/${_realname}"
    mkdir -p "${a}"
    cp -r "TortoiseGit-64bit/SourceDir/Program Files/TortoiseGit"/* "${a}"
    cp -r TortoiseGit-LanguagePack-64bit-*/"SourceDir/Program Files/TortoiseGit/Languages"/* "${a}/languages"
    rm -r "${a}/common"
    _rmmsdll "${a}"
}
