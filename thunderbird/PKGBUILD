# Maintainer: David Macek <david.macek.0@gmail.com>

_realname=thunderbird
pkgbase="app-${_realname}"
pkgname=("app-x86_64-${_realname}")
epoch=1
pkgver=68.9.0
pkgrel=1
pkgdesc="Standalone, easy to customize mail/news reader"
url="https://www.thunderbird.net/"
arch=('any')
license=('GPL' 'MPL')
replaces=("app-i686-${_realname}")
makedepends=("p7zip")
provides=("${pkgbase}")
options=(!strip)
source=("ThunderbirdSetup.exe::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/en-US/Thunderbird%20Setup%20${pkgver}.exe"
        "ar.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ar.xpi"
        "ast.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ast.xpi"
        "be.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/be.xpi"
        "bg.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/bg.xpi"
        "br.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/br.xpi"
        "ca.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ca.xpi"
        "cak.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/cak.xpi"
        "cs.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/cs.xpi"
        "cy.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/cy.xpi"
        "da.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/da.xpi"
        "de.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/de.xpi"
        "dsb.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/dsb.xpi"
        "el.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/el.xpi"
        "en-GB.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/en-GB.xpi"
        "en-US.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/en-US.xpi"
        "es-AR.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/es-AR.xpi"
        "es-ES.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/es-ES.xpi"
        "et.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/et.xpi"
        "eu.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/eu.xpi"
        "fi.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/fi.xpi"
        "fr.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/fr.xpi"
        "fy-NL.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/fy-NL.xpi"
        "ga-IE.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ga-IE.xpi"
        "gd.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/gd.xpi"
        "gl.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/gl.xpi"
        "he.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/he.xpi"
        "hr.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/hr.xpi"
        "hsb.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/hsb.xpi"
        "hu.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/hu.xpi"
        "hy-AM.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/hy-AM.xpi"
        "id.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/id.xpi"
        "is.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/is.xpi"
        "it.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/it.xpi"
        "ja.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ja.xpi"
        "ka.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ka.xpi"
        "kab.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/kab.xpi"
        "kk.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/kk.xpi"
        "ko.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ko.xpi"
        "lt.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/lt.xpi"
        "ms.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ms.xpi"
        "nb-NO.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/nb-NO.xpi"
        "nl.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/nl.xpi"
        "nn-NO.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/nn-NO.xpi"
        "pl.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/pl.xpi"
        "pt-BR.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/pt-BR.xpi"
        "pt-PT.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/pt-PT.xpi"
        "rm.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/rm.xpi"
        "ro.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ro.xpi"
        "ru.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/ru.xpi"
        "si.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/si.xpi"
        "sk.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/sk.xpi"
        "sl.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/sl.xpi"
        "sq.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/sq.xpi"
        "sr.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/sr.xpi"
        "sv-SE.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/sv-SE.xpi"
        "tr.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/tr.xpi"
        "uk.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/uk.xpi"
        "uz.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/uz.xpi"
        "vi.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/vi.xpi"
        "zh-CN.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/zh-CN.xpi"
        "zh-TW.xpi::https://ftp.mozilla.org/pub/thunderbird/releases/${pkgver}/win64/xpi/zh-TW.xpi")
sha512sums=('e5a9c694071cec7aed18430ddf220fad233907786ed3ad445ffe76be41305d1501eafbb9eb68141adc57be62dd1eeb8317b9167837a90a1bbb34274a7b557adc'
            'd096cee5e9f882228a9b5b062713a1e7b6013514cdc762a7418ca52d1cc653482c4bf4a7d39dc1d5ce716db235c0a2496dcd0a9488ea03f60c0413666509e164'
            '827c4e36b3d3223e21372afb4142c3f5689dfa50095e896f17a1c9349dfb4804451390f3269972cda71f7005b038afd06901aee3aacc879ca5bc3ce663b0f89e'
            'a529a54979be4f20202c8bbca57f02f9cdb9794e47c6aa43f2b0847ad9550e8c1681cd37cbdcf33fe66033670f99f640409fa43a442545608dd5fc79a70d95ec'
            '7c13004dd15af6ee20edaaf46b7be7c9bb89a192c303131e558a60f74d8a0cfb5789bd13aaf60c9926fda75c845858340a9b53370eb08666660d854754817506'
            '6a2672ef824b02fb99d98956571e7586a302376ac59d265bb06227f83556e53b6a2bdc4482843430eb2835e7413434c5d61100a0dc24a1960d5d87077f06d996'
            'f6309c235c8e349901000f38e0d254a9719e89792cccd334b0d488c771e4702972874d47020355ba15133248a15c7fbb9bf8c4c621500475c043648cf217fc11'
            '5e6b466562d157c0d0a22c30dd4ab3067cd2cc905b5b7e176128cb7bad08817a0b77a17a03dd7c30cee36cd964b5818a71ea977420b4145aba2b336f3ec935e8'
            'e09962a301a26682582654d43ce8a95ce788e0896826f4dc03c9f6a0d7c642663f067c6e01d1b996b27a76b94527c5b63d2bf42de478b8c157bd77c771219254'
            'a405fe2d14bb970cbc978550392262b7cb6ddf8839fc5164753d5bc73ea5d2506d2a78c6d4c8473ab32b668fc4ad37977576dbad89149fc6ff7325c89b0791ba'
            '923c7f128aaa540f480582e1d8373966a3a4e196e7163803e481ed52076745c4e3fc27d01f14ae1dc2264e6d6e2bef096fe5312ef96fe8449c75b8f57b2f3198'
            '9429225ff96c79270cf05cee842bf7e3af5ac891cfa5f947dae65de3b08fca2e007cd5a2adc479ff2df79cda4c152012fef37a0469a35e7145321afec2f7b0b6'
            'd0add63b3490737c680fb9b1549b4207728500c0fe5c5b9bd43c036180710858f56868990c8f9043093a3ead0e00fd1070067a2f74730332afdac32b18b9a9f8'
            'bb40b62dc1ec467ebf553caf0965a489fdf2e7fa7c7a7e6ed45dd48dc8dd5c9930e20ae6a7b26b687ed73d48a887228a2ccd5dadc7c0f7152d90c64b1ee6f145'
            'a2f0c33ec9436f8f0c1e96025ab8cf5a84c74afc486337e8fc797b12a3aaf3d9a706ed28a83a66cd9471e46f7df95c80dc11140cfdc767022f14c478455eb6a6'
            'cac57386bc09608924c2d6b5065607d2b7b5bc552c852ba8606328234816c56d9b8b1d05f9c5226b8397a55a339766ea36bd7339722ac4764d70deb9578a538b'
            'a6989167555e2f9f3ff2916e9c6186309e7dce161c3f4425592325c55295081ca61df26e62f72f31dda95d26f0bc9819f772ae73465d31cab66b877289a34580'
            '4a1ffabc8708c6935fe89715350480bae346e90ca5421c1a0dd32db94a80b4850677ce2d23f1f7c4e1c0c31eac8e76783605fddbcf5cf5372b38c6190ae12336'
            'c8c5a3b1571e69b18b80df76b904d377bced953e1a2c93982443b40516c4b440fcc9400a3eccb8cff745923fe7f2e833939caadf21d89bc3f08cee9a16acc3c5'
            '8ec8f3b0ef19c719687736969cdd4b6c0470440d8f405812db8d5c9d520a70ab8a59f477771e7b2420a9849e087e6aaaf0874df8b5df791688121e0d0000e717'
            '06116cda2d8a62a5ffc27e5d6299e23956ce4b00751784f65417fc2b6346e08b1eb59f9fde2c00fb8f4f8a352acbe2d82dea42b7e317160d3a7bb3669243d19f'
            '1737b073a49567e188d55aec86ce0b4418abe8541641559307a5ec3a7891a0feb8c66ad18869ef95715b4c3b116f7459407f8442779fbae681836ba5f9837239'
            'f3cac80f489fff742eb8660debc8e4f9fc4451e1fddebbcd0dfb19fd482c8d99283df8b3f3782647471656d42367ebce9a524e057a8490ee641b10a01d3b0b8e'
            'd6b5fa41f8a37b478631f14552219ee8e59a0f4ce6c9459495d7a4b963511e232e0f1dfbd8d0f086358dc9e0eeb8ecb22d983610014e0665cb959bd1cc6c9723'
            'f4f3e40fb0c3cc69d8fa154faed4b856bba5decd9c545e0b34a5bc2a5ff2f1110b36277b3b3c88ac3e72a460cecd79d3468cf57948985d353c7dbc4f373a455c'
            '258990722950615a1fba9e5d0cf53008fcdd95616eab67008f8b56621f1f7ce818dd199a71c0c5fa01f78b3e9b09b9051f4c1cfcfd07c1bac556de7c09850661'
            'ece70edb1f5e736f78f08afa151073d6398f5ea3eb79cf0de1d85c95fd4aa62ffc915c808cb211bd4df8b80d4c060674cb92be268e4fb36383a6ecc8ab7261f2'
            '5dc0b7ee416e4c2fef9addfd660d3522a994ac0962bd68b32ed63d2ae55876b65dfd31d07de4d0eed51230ec8e4ed9b36269a03af1d54df8902e6e9a8e8a2302'
            '8213f484aba22dda9ea45dced29be71914632d79c72c172bf3787cf340815de5a8e2cd73c28dbff7ca7035ac5150be1f3f2192aaba98e1fab84fcebfeffb137e'
            '2184a355dd31de819ecd45790248332023b0e62fa45aea2d0f992887df72e75671c8261558fe15d02bd3ebd62a23c67884e2682ae73c2fe57ebc2b81827655b1'
            '984c3dbb490805bac52aae51d4f392e9aa5769d886a30130d8e94b22eeb798cd7cd3c4c53e468a958b221f911fae7f88b43292181104ea78cff0a74ba2980131'
            '97971103fac8f7b4ec69666f892f3422916ab6a4ba9636a5f6f75e9f2b526ef08702913e79eb95187d854e4983d2723d64dcb6fc6d9a3cb5b37ec8330bc6782a'
            '9f19246d332437a76575a3c4d94129945fc7fbe2e25d8a0ddc6946e49570b73d974786683252c9c6cf12ab19896dfff4e04e0c42a8ab868ecb869f2aa79b8f7c'
            '9fd1e541393036534739480246062620489b421309fcc27c86b2e10ac3efdf8c0c8b9baf13fc8b5488204880d6528e783015bf3e409b4160856e56d3b6588a34'
            '0a96c8b1a6452ca15d8d1a4a8280221d31591a238f21830903ed3cf15d6ffbd66cadc0ed2185f1274052e54040e49fb76bd69037da7c043252c2815ea8489fa2'
            '28b1ce9ba84ce2560f38ba4f6a4ffe8657e983fb77193fd3934c28278bcc356d059ada0f1e78734b3a25f69abe3784964f206b004e9b12f56779872e7c2e4bba'
            '47414d445feb6e3cc2b216e0ecae2b0a1de1c9a8f3db3a5834fda8af162301b63827e0cf505ba1f1fdb3329fbaba78782ce6cd80cda6ae9bf78269c4df7d19ad'
            'f00920f98d2574a6daa340633c34914bc149a65f35ffee053bc8cbbca3a08d3e66cad53309d7ebf7e61b141f0ab5b949afe3376258cc797ac09dc741177f77a8'
            '41eed1aee1e45b94f987a1be413103e01cc2b2399b7fc9c0fa07d1a936c71d894f35bc69d79605143702966206b91c50a4cf810f2e27a175bd729099a0e04ba2'
            'f8dcd03f4d65a934850692a77800d16d6559b27b9c67ba6a5a0405a85c9506912a831d41ee1ff5539752be7b0e65c3039209257b62fae2053cc6bb8d1e109b0a'
            '055ccf8f717c73308d3c6e76a40957c57082671b2f428ae4880559224ea0091fa65908bdda3af11ac55ed8292f8b200db0ef39692af48651b699456635394c48'
            '7a5605e421902b202d45266b0ce17f149495fe90580f0bfd64667454d5b829ff8da5ed49aa65fe5313baf5cb0300918b2659120c3dd66614e80c4b137dbf8a26'
            '9066e5d823265681dc4ef21eac10692bad7dae6ab9ba6f43ea1c6441caf3228f5b1228b457966a2de39ad47e18f0f4deab05765d4f18cf61459b58e2c2170283'
            'f7331604d1b7dc51993548f826d180a92980357ded57dc6c5b7577244c10434239f410f9aff5efcbc5e4341651dbb7044c3aba1035c8c7b9e495763cce67644d'
            '5b99db9bd50e87089a4f336f59605bb1d3feba370bbf634614ba44d14d082c32de815f4358fec03b5802832ddee8323f824f51ab3a49466a299125638fe79189'
            '657145c5222938da6d86eb803798ac62542c9b2a923d7a8589505c50b382754973b8d07d60173354743718a674bb6fb1a6533731d22dbb122a61a9a0bcd74e8c'
            'de6d9759b2859e7cd8fcfefd59877d660cfac99e43bb53ac8188fc655f5e2b73ddf9cf230649ceaeb23ae4ff02b3196c66ba9708012c7b1944e5eb606a97c7ec'
            '035f171333c1b35798e82f9259f5bc3566ba0a3efc0c838e334e4562572c2b5376b5cc1f9329c9e978b71eb13046737b0ea113be2df35989299812b410b8bb8f'
            '83408318579d09bb60365c447fd61bf22528468e855f05b80763b2b71340e07d5484206e82fb30f5b8715edcea09139db5d8c738897ba4abb42b8f70a88ceb49'
            '6d93a01a8ddb3bdf3b3068f8e8d0ef5d306dfee595f4017141410e6089ae762ff84b95360098742f9695e8588786f6ca8628255c8d2febc957c73ab93c15fca1'
            '069fab111205b03aa2de660e3e49a58146d6f9034ef4cd5c10d6636f193ad4b9e0fc0db2ea85d303783f3fc125f90a057c0cd0734bb8bf96cf157be11515b57e'
            'a2dec84000e3770fe0c3a11c14b4bee6107f64d28036f6f573cdf9c09b4215eda841aa4b466274932075636d57ea577c0b91e9f74d2b5b4349c0b1ecfa30d187'
            '9cc70cd6d11a39a187686166e7fa5cdecc400289e40a0875e0bc3f15d3ae6eaef511fffef8c55101c8749d3756a8442fd12b6313c33ba6df1e6014102c46b8b9'
            '2f6f71af0024d62c76c25687ef99827667573c01dd6eb6c02a4b748765a27cd222f23fff85fe6abd6c17d1f4d70f79daf902102b728a17ff9b8cd3b42dfa046c'
            '5aa66421a4213f6420f8ac2e4bd810925273ebe030846b30f0693cd141b81f0e5311f8cba32e229745eb7b0bb290cd5108e3b8014d3e4adca57fc7b1f70ca4b3'
            '1bf56217165f05ecc5211a23e5fc085806bfd1a12ddc072b8352922fdedc967d5d8b673c500dbd89e6f4543274529bc4f652a541d352c3c2736cd06035084eb4'
            'e5aa62bb14485a134aa9934b6bb31677bec424a4faf134f73407cf40e59e1aee22531c3c15b424a654a4c7cb9f8b048b2c02580d18b53ecc5b50f7d3fb8abe55'
            '9eecab967b679f3ec6defb726daaaea79f3b60ed40d4f17e2045583dfb5e37dab4da70d822f99b1035c684b4381da44f333e6b30a6aa851a47ec9995a92979d2'
            '1e09661cbfea25de82964529f327e5848776d244c8eb2a35d4d5775a14cd223922932ad9d2fd32f02151d396874d3f6925bdf5e5d8935b45df54c15dcc8b83d2'
            'fe1097bf6084453ac0595d027d9bd916a10de67f68d3addb335a5cff5934c54b9431d3408df958d99a8643c3880af0665f84458f62873d4006836ca043b0aa69'
            'c9b83bae6eb913b68f65532d78db4f32666015f2dc23e706f98a8a00ca9c89b98c96c3ec45d9bbe93079397fb0e0e01ef2b6d667200ee6cdfce4a5faa7919cc3'
            'f7a707c7f31167b2fda8e81363c8544bdd123d82dbfa1f732ed5594e6420bf0d767abcca3a9b4a04896d32dd4f2ec4fd98b6d0ee676ed1e441cd32cd5512fc7c')
noextract=("${source[@]%%::*}")

_lc() {
    local d f n

    for f in "${@}"
    do
        d="$(dirname "${f}")"
        f="$(basename "${f}")"
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${d}/${f}" "${d}/${n}"
        fi
    done
}

_rmmsdll() {
    local ms

    ms=("msvbvm[0-9]+"
        "ucrtbase"
        "mfcm?[0-9]+[a-z]+"
        "msvc[rp][0-9]+(_([0-9]|codecvt_ids))?"
        "vc([ao]mp|corlib|runtime)[0-9]+(_[0-9])?"
        "concrt[0-9]+"
        "pgort[0-9]+"
        "api-ms-win-[0-9a-z-]+")
    find "${1}" -iname '*.dll' | grep -Eif <(for m in "${ms[@]}"; do echo "/${m}[.]dll$"; done) | xargs -r rm
}

prepare() {
    7z x -y -bd "ThunderbirdSetup.exe" -o"ThunderbirdSetup.dir" > /dev/null
}

package() {
    local a="${pkgdir}/apps/${_realname}"
    mkdir -p "${a}"
    cp -R "ThunderbirdSetup.dir/core"/* "${a}"
    rm "${a}"/maintenanceservice{,_installer}.exe

    # remove system DLLs
    _rmmsdll "${a}"
    sed -r -e '/(VCRUNTIME|MSVCP)140.dll/d' -e '/api-ms-win-[0-9a-z-]+.dll/d' -i "${a}/dependentlibs.list"

    mkdir "${a}/extensions"
    local f
    for f in *.xpi
    do
        cp "${f}" "${a}/extensions/langpack-${f%%.xpi}@thunderbird.mozilla.org.xpi"
    done

    _lc "${a}"/*
}
