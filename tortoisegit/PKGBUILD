# Maintainer: David Macek <david.macek.0@gmail.com>

_realname=tortoisegit
_choconame=TortoiseGit
pkgbase="app-${_realname}"
pkgname=("app-x86_64-${_realname}")
epoch=1
pkgver=2.13.0.1
pkgrel=1
pkgdesc="Git client implemented as a Windows shell extension"
url="https://tortoisegit.org"
arch=('any')
license=('GPL2')
replaces=("app-i686-${_realname}")
makedepends=("app-lessmsi")
provides=("${pkgbase}")
options=(!strip)
source=("TortoiseGit-64bit.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-${pkgver}-64bit.msi"
        "TortoiseGit-LanguagePack-64bit-sq.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sq.msi"
        "TortoiseGit-LanguagePack-64bit-bg.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-bg.msi"
        "TortoiseGit-LanguagePack-64bit-ca.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ca.msi"
        "TortoiseGit-LanguagePack-64bit-zh_CN.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-zh_CN.msi"
        "TortoiseGit-LanguagePack-64bit-zh_TW.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-zh_TW.msi"
        "TortoiseGit-LanguagePack-64bit-cs.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-cs.msi"
        "TortoiseGit-LanguagePack-64bit-da.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-da.msi"
        "TortoiseGit-LanguagePack-64bit-nl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-nl.msi"
        "TortoiseGit-LanguagePack-64bit-fi.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fi.msi"
        "TortoiseGit-LanguagePack-64bit-fr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fr.msi"
        "TortoiseGit-LanguagePack-64bit-de.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-de.msi"
        "TortoiseGit-LanguagePack-64bit-el.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-el.msi"
        "TortoiseGit-LanguagePack-64bit-he.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-he.msi"
        "TortoiseGit-LanguagePack-64bit-hu.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-hu.msi"
        "TortoiseGit-LanguagePack-64bit-id.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-id.msi"
        "TortoiseGit-LanguagePack-64bit-it.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-it.msi"
        "TortoiseGit-LanguagePack-64bit-ja.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ja.msi"
        "TortoiseGit-LanguagePack-64bit-ko.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ko.msi"
        "TortoiseGit-LanguagePack-64bit-lt.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-lt.msi"
        "TortoiseGit-LanguagePack-64bit-oc.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-oc.msi"
        "TortoiseGit-LanguagePack-64bit-fa.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-fa.msi"
        "TortoiseGit-LanguagePack-64bit-pl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pl.msi"
        "TortoiseGit-LanguagePack-64bit-pt_BR.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pt_BR.msi"
        "TortoiseGit-LanguagePack-64bit-pt_PT.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-pt_PT.msi"
        "TortoiseGit-LanguagePack-64bit-ro.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ro.msi"
        "TortoiseGit-LanguagePack-64bit-ru.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-ru.msi"
        "TortoiseGit-LanguagePack-64bit-sr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sr.msi"
        "TortoiseGit-LanguagePack-64bit-sr-latin.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sr-latin.msi"
        "TortoiseGit-LanguagePack-64bit-sk.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sk.msi"
        "TortoiseGit-LanguagePack-64bit-sl.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sl.msi"
        "TortoiseGit-LanguagePack-64bit-es.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-es.msi"
        "TortoiseGit-LanguagePack-64bit-sv.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-sv.msi"
        "TortoiseGit-LanguagePack-64bit-tr.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-tr.msi"
        "TortoiseGit-LanguagePack-64bit-uk.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-uk.msi"
        "TortoiseGit-LanguagePack-64bit-vi.msi::https://download.tortoisegit.org/tgit/${pkgver%.*}.0/TortoiseGit-LanguagePack-${pkgver%.*}.0-64bit-vi.msi")
sha512sums=('3fb33fa7121da51e25d4130eef614984e4e72ab06741f60617f78367bb5c940369b3364428978eabfa7f68ed3943d10fd567a9d0a7ea9aa19375f754e8135bed'
            '2656acbb541a71bcab75230aebaf347d527d7f417fcc7104561d2fb47f237c6c43888a4b733cf7de853433c3a1138939e04a3c1d2aa4b2d808b2b6f578e02996'
            'dd0dc99cb0f883bf8be01817777f8cad1eeaf97a64dabb98383a62ad12e904109b4bcf3569e587aead4c35d45f13cad0b002f8eb82ed76a744dca1addae1edde'
            '7139244eac548075f8e53f87541cfc343807c686c45db84af3f1a29710da9acc6dae53fc3e708b0384158a54412d337deaf98183a7827ccc28b18b609ff8bc1a'
            'c79df8e0076765387a5ccc50bba44b0092625e50eb95a5d49e370ad5f5ad839f6ba7826461b6218d103e6c7bf709690fe5b466a61db0e0134797c331d7b9b315'
            'b3f934decd3ec3bbcf53974c02b6cbaede22f77fedd956afe6f9e4d1cff03e25532eaae956051cd8f0d3bbac1fd49c4a31f83565c7e12a97e3baddefbbd59267'
            'efccaeab36db18a9eaf2ea65d732157d3fe662e6f2d33b93ca7638a0eb5c23cddee9fa72410c5b57df76df234fe2a43f9c5275d3145ad702b41de22404a58a04'
            'a56da706f0cde824ad501242e76458efd869d11e72e9977f0108573aa08904f501aaa7901d565f2f1fc653f0b67a9da5ee0a5e284f4e1a25661da1f576f80640'
            '55c955faba783ac205f7c9a9c8260d112a607367c36f3c0dca42010610a717e0f2938b529fbcb852db401fdd9725bb2886db4aad49767ebe74fe8a3068574b1d'
            'c8bc074ee6661bca673e5479884f88be6c99979f3cbbc5908fc3866e552d13c004f61c579f0e1bcae1d494ac0b3c9779d27f314b2f619114b233f7a0b44674c4'
            'dabf059ca0770ef9bd1c918fd46a1375cbf68edf821a56431f471eb0181d8dd5c4b9a2c8664bdb5b8519eadcffc5e885209bd16b3a86d2fa3514eb6d525fbe84'
            'b19cf28866b4b72a96b063083e7f24329a6bf18638f0fc71a9bf492d717e17c5267df9ea16dc738ed8d3d5323e0d53d908a7f30044049bfdd7f5ae97490ca67a'
            'b975dfbcd51e98f7123c16132ff5d8686f722efe1146b4d5fca047f9dd61b20b70d46b9c69cd58b9d5c9fee052e4a4525884d6a5db4b29d0a7eb77be2cf6fa96'
            '7484551ed74a841802f48dd420604725158787fd8789f014570f0cc82658dc6ed1d7af1c600c737ee246a47dbfcbe421439675ebb07672c7882b3c86ebe1a046'
            'fc104a8bab0cfb9a9ee45b140adccf68c4fb476ea560bc957a16bbd4001104adfee579d5a45e1badfa55d87d0c7f4dd71dad5357d061d50dfe6c5666d13073a4'
            '9db5ba3faac0403bf5f3ea1c2e77e1593985dee22c8c4b81d320b9da6cf0382073bbf9b2d243f86bc4523f164ad11ce15f4cdcbbba8522def4ee5daadffa075a'
            'd47c5e62bc43a447955e204b761a5dc9e6989911148e205da7c71b3779d0c741019a09ebf79f7808832cc04954b6d57a357f6c91b6c0f36ca3a23e24bdf058f4'
            'd199bed1a6cfee09de7b55fbac0b29ad68513ee21c2d30375baadc3f2c9e158bc9bbb5a5ddeb7ee7e002d54ffa3be20047116c0859b93eec1997b62ab70bd66b'
            'dac6187d972c697a0b66535fe95da704edd24c8c8ca1583da9a0a2cae5b35140330442fe04043580c3253e935dd4304035879f4e15508e828581a1cdadd0dd3e'
            '6be1e033fd6b49f42e2469be7c7c5e39668c814907c2f06dc3a3bfe62fa98de232e834432c7b05ad387171a1759b722d7a5f4fcb1eecbfe7af752129a0c64566'
            '683f983d78294d29a76ba052ae8566c5f34f79ca611cad2e1d26ab49f0affc1db41cc9729b5d0a9963653948b0ff73512e4f654d6571d851b1372e4e0c52ccdc'
            'e42ca061d7e9a490f2da6220ec174be9a93c61b83a5ca67f78c52563caaabc1443ece9fc1b2d733aee7a80b0add2a0ccf272fe3085659433f435a52465492659'
            '008a344bbd1a2c75ef663d93f4284f0bc132f94ca5a233ff92180611f7b4059b35b27c25503c47df9a4497b809ffd8873d1064e0a9b4437f9aaf31af67360235'
            '45592eacc5abdfc3047206a3c8607e4f91a07c6c1f777288d40cc77510f12a34fef736b01d883f24e3fdc2461116bd1bb9028ddebaf83a82d4aff5d77a33b74e'
            'dfe3060c2c6adf14b31833f69c4862906481911e123ab32ff42a03d6996316765adbfbfb2b66ae4f8f43129e04c68dd37b43405ed17e7307a63aafc7c2e2d6dd'
            'e38cbf9b697bc8b926030a6747ed83229a3b0ca84f9f5d3844e6969664292663f3964bfada5c3ae15057019782f4f9e3445661bb5ccfb21862b16ffcee5ca9be'
            '825cfde2b120dfa51d6109b816babb2bf9d03a584b2ab9d9e3a7e55c5c581d6937494b0739edea092abe9e0814d7165d966d538cdfa39905c02de3d264c0f9f9'
            '758f84ed2b7e4934d80e0535b8a1b2d6be1bb1f0f4365c0c540a348dd532ec8ea06e7d4bc691219321e4b1c361d379bdc88cf661553c7df5b0bd131a913750d4'
            '78e56e8849f18525e3bc9d88228123f19f2765371413745c98b9bb84ba873d42d836c572d0773e756d961d5e7408a12b8f95a6dbd3e81747d677926488f43b0f'
            '50fe66e8813eeb38368c608a37e5ddffbdea17c706c436a35d8b10cd536bf617cf1653b35273a28745ee9d326eda90d2b3d75d27b375517d94d57d817470218b'
            'bb7ee7b9e57587c53fdce5cbab179b1b952dbd19d6d04bf3314e352c5b1c959e81743228e466a7eb95fa71acdce4c02174dc1b45ad3097d998f0a4059b7ce12a'
            '019195c91c13dc8f94faf729d1bcd0278b1f8b4d7447f4cd329c9f3a438c44c5cee7f538464b15492bfbec1aa156eb20bbcef7e2a7bd98c776a4f442733b794e'
            '73a486edf8765fb3ecd5df9c27a3f9dc78ac1b7a6c8b2ecc89a1245c4318c147ed64269e3c944093d83e6062f10720989f000a6bef1046a49bb264bcdfd38c10'
            '0f08371b9987077beb0a9b65b96282068b7ac47402e853b6bd583f9b2a0d327ed13ae0d2a08510642ec17f690d7a6f40b81c96e30051e32fd9c7563bc011b252'
            'e6f50b788c79da90bb97ee6954c824f67fa490206e0d506d0fc3820b859bcc8d957b87f85d27c7464f22ed0ce3bb356e68b106114079a13bb661805e81dafe11'
            '8c2caeb8b15f3ddc74b454d5289642457584ca85427a40075400f03851b2d3442b43d3a192b8a2ac645bfae123e48e125453bb585b172e931bdc361a18e17645')

_lc() {
    local d f n

    for f in "${@}"
    do
        d="$(dirname "${f}")"
        f="$(basename "${f}")"
        n="$(echo "${f}" | tr 'A-Z' 'a-z')"
        if test "${f}" != "${n}"
        then
            mv "${d}/${f}" "${d}/${n}"
        fi
    done
}

_rmmsdll() {
    local ms

    ms=("msvbvm[0-9]+"
        "ucrtbase"
        "mfcm?[0-9]+[a-z]+"
        "msvc[rp][0-9]+(_([0-9]|codecvt_ids|atomic_wait))?"
        "vc([ao]mp|corlib|runtime)[0-9]+(_[0-9])?"
        "concrt[0-9]+"
        "pgort[0-9]+"
        "api-ms-win-[0-9a-z-]+")
    find "${1}" -iname '*.dll' | grep -Eif <(for m in "${ms[@]}"; do echo "/${m}[.]dll$"; done) | xargs -r rm
}

prepare() {
    local f
    for f in *.msi
    do
        rm -fR "${f%.msi}"
        /apps/lessmsi/lessmsi x "${f}" > /dev/null
    done
    _lc "TortoiseGit-64bit/SourceDir/Program Files/TortoiseGit"/*
}

package() {
    depends=("app-tortoise-overlays")

    local a="${pkgdir}/apps/${_realname}"
    mkdir -p "${a}"
    cp -R "TortoiseGit-64bit/SourceDir/Program Files/TortoiseGit"/* "${a}"
    cp -R TortoiseGit-LanguagePack-64bit-*/"SourceDir/Program Files/TortoiseGit/Languages"/* "${a}/languages"
    rm -R "${a}/common"
    _rmmsdll "${a}"
}
